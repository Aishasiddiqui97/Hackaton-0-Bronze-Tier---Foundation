# Plan Generator Skill

## Purpose
Automatically analyzes tasks from the Inbox and generates structured Plan.md files with risk assessment and execution steps.

## Type
**Reasoning Skill** - Autonomous planning agent

## Risk Level
**Low** - Planning only, no external actions

## Implementation
**Location**: `../../AI_Employee_Vault/reasoning_engine.py`

This skill is the core reasoning component that bridges Bronze and Silver tiers.

## Functionality

### What It Does
1. Monitors `AI_Employee_Vault/Inbox/` for new task files
2. Reads and analyzes task content
3. Identifies task objective and context
4. Breaks down into actionable steps
5. Assesses risk level (Low/Medium/High)
6. Determines if human approval required
7. Generates structured Plan.md file
8. Routes to `/Plans` (low risk) or `/Needs_Action` (medium/high risk)
9. Logs all planning operations

### Plan Structure

```markdown
# Plan: [Task Title]

**Created**: [timestamp]
**Source**: [Gmail/LinkedIn/WhatsApp/Manual]
**Task ID**: [original_task_id]

## Goal
[Clear, concise statement of what needs to be accomplished]

## Context
[Background information, why this task exists, relevant details]

## Steps
1. [First action step - specific and actionable]
2. [Second action step]
3. [Third action step]
4. [Continue as needed]

## Risk Level
[Low | Medium | High]

## Risk Assessment
[Explanation of why this risk level was assigned]

## Approval Required
[Yes | No]

## Approval Status
[Pending | Approved | Rejected | N/A]

## Status
[Planning | Ready | In Progress | Completed | Failed]

## Notes
[Any additional context, dependencies, or considerations]

---
Generated by: Reasoning Engine (Silver Tier)
Plan ID: [timestamp-based-id]
```

## Risk Assessment Algorithm

### Risk Levels

**Low Risk** (Auto-approved)
- Reading files or data
- Generating reports or summaries
- Moving files within vault
- Logging or monitoring
- Internal calculations
- Data analysis

**Medium Risk** (Requires approval)
- Sending emails to known contacts
- Posting to social media (pre-approved content)
- Modifying configuration files
- Creating new files outside vault
- API calls to external services
- Scheduling tasks

**High Risk** (Requires explicit approval)
- Sending emails to new contacts
- Financial transactions
- Deleting files or data
- Deploying to production
- Bulk operations
- Sensitive data handling
- Legal or compliance matters

### Risk Detection Logic

```python
def assess_risk_level(task_content):
    """
    Analyzes task content and returns risk level.
    """
    content_lower = task_content.lower()

    # High risk keywords
    high_risk_indicators = [
        'delete', 'remove', 'payment', 'transfer', 'purchase',
        'deploy', 'production', 'publish', 'broadcast',
        'financial', 'legal', 'contract', 'agreement',
        'sensitive', 'confidential', 'private'
    ]

    # Medium risk keywords
    medium_risk_indicators = [
        'send email', 'post', 'publish', 'share',
        'modify', 'update', 'change', 'edit',
        'create', 'add', 'configure', 'schedule',
        'api call', 'external', 'third-party'
    ]

    # Check for high risk
    if any(indicator in content_lower for indicator in high_risk_indicators):
        return "High", "Contains high-risk operations requiring explicit approval"

    # Check for medium risk
    if any(indicator in content_lower for indicator in medium_risk_indicators):
        return "Medium", "Contains operations that modify external state"

    # Default to low risk
    return "Low", "Read-only or internal operations only"
```

## Integration with Silver Tier

### Input Sources
- Gmail Watcher → Email tasks
- LinkedIn Watcher → Social media tasks
- WhatsApp Watcher → Message tasks
- GitHub Watcher → Code/repo tasks
- Manual → User-created tasks in Inbox

### Processing Flow
```
New task detected in /Inbox
    ↓
Plan Generator reads task file
    ↓
Analyzes content and intent
    ↓
Generates structured plan
    ↓
Assesses risk level
    ↓
    ├─→ Low Risk → Save to /Plans → Auto-execute
    └─→ Medium/High Risk → Save to /Needs_Action → Wait for approval
```

### Output Routing

**Low Risk Plans** → `AI_Employee_Vault/Plans/`
- Ready for immediate execution
- Task Processor can auto-execute
- Logged for audit trail

**Medium/High Risk Plans** → `AI_Employee_Vault/Needs_Action/`
- Requires human review
- Approval Status: Pending
- Waits for human to change to "Approved"
- Then moves to execution queue

## Plan Quality Criteria

### Good Plans Have
- ✅ Clear, specific goal
- ✅ Sufficient context
- ✅ Actionable steps (not vague)
- ✅ Accurate risk assessment
- ✅ Realistic execution order
- ✅ Dependencies identified
- ✅ Success criteria defined

### Poor Plans Have
- ❌ Vague or ambiguous goals
- ❌ Missing context
- ❌ Steps that are too high-level
- ❌ Incorrect risk assessment
- ❌ Missing dependencies
- ❌ No success criteria

## Examples

### Example 1: Low Risk Plan

```markdown
# Plan: Generate Weekly Summary Report

**Created**: 2026-02-16 10:30:45
**Source**: Manual
**Task ID**: weekly_summary_task

## Goal
Create a summary report of all completed tasks from the past week.

## Context
Weekly review to track productivity and identify patterns.

## Steps
1. Read all files from AI_Employee_Vault/Done/ with mtime in last 7 days
2. Extract task titles and completion dates
3. Categorize by source (Gmail, LinkedIn, WhatsApp, Manual)
4. Calculate statistics (total tasks, by category, by day)
5. Generate markdown report
6. Save to AI_Employee_Vault/Done/weekly_summary_YYYYMMDD.md

## Risk Level
Low

## Risk Assessment
Read-only operations and internal file creation. No external actions.

## Approval Required
No

## Approval Status
N/A

## Status
Ready

## Notes
Report format should be consistent for easy comparison across weeks.
```

### Example 2: Medium Risk Plan

```markdown
# Plan: Send Proposal to Client

**Created**: 2026-02-16 14:15:30
**Source**: Gmail (email from client@example.com)
**Task ID**: gmail-19b6fdde257c24a2

## Goal
Send Q4 proposal document to client via email.

## Context
Client requested proposal by end of day. Proposal already prepared and reviewed.

## Steps
1. Locate proposal document: docs/Q4_Proposal_ClientName.pdf
2. Verify document is final version (check last modified date)
3. Draft email with professional tone
4. Attach proposal document
5. Send email to client@example.com
6. Log sent email in sent_emails.json
7. Move task to Done

## Risk Level
Medium

## Risk Assessment
Sending email to external contact. Content is business-related and pre-approved, but requires human verification before sending.

## Approval Required
Yes

## Approval Status
Pending

## Status
Planning

## Notes
- Verify client email address is correct
- Ensure proposal has no confidential information beyond what client should see
- Consider CC'ing manager for visibility
```

### Example 3: High Risk Plan

```markdown
# Plan: Process Payment to Vendor

**Created**: 2026-02-16 16:45:00
**Source**: WhatsApp (message from vendor)
**Task ID**: whatsapp-987654321

## Goal
Process $5,000 payment to vendor for services rendered.

## Context
Vendor completed project milestone and is requesting payment per contract terms.

## Steps
1. Verify invoice matches contract terms
2. Confirm services were delivered and approved
3. Check budget availability
4. Obtain manager approval
5. Process payment via accounting system
6. Send payment confirmation to vendor
7. Update financial records
8. Archive invoice and payment receipt

## Risk Level
High

## Risk Assessment
Financial transaction involving significant amount. Requires explicit approval from authorized personnel. Potential for fraud or error.

## Approval Required
Yes

## Approval Status
Pending

## Status
Planning

## Notes
CRITICAL: Do NOT execute without explicit approval from authorized manager.
- Verify vendor bank details match records
- Confirm invoice number and amount
- Ensure proper documentation for audit trail
- Consider requiring dual approval for amounts over $1,000
```

## Configuration

### Tuning Risk Assessment

Edit `reasoning_engine.py` to adjust risk thresholds:

```python
# Risk configuration
RISK_CONFIG = {
    'auto_approve_threshold': 'Low',
    'require_approval': ['Medium', 'High'],
    'high_risk_keywords': [...],
    'medium_risk_keywords': [...],
    'financial_threshold': 1000,  # Dollar amount requiring high risk
}
```

### Plan Templates

Create templates for common task types:

```python
PLAN_TEMPLATES = {
    'email_response': {
        'steps': [
            'Read original email',
            'Draft response',
            'Review tone and content',
            'Send email',
            'Log sent email'
        ],
        'default_risk': 'Medium'
    },
    'report_generation': {
        'steps': [
            'Gather data',
            'Analyze and summarize',
            'Format report',
            'Save to vault'
        ],
        'default_risk': 'Low'
    }
}
```

## Monitoring

### Health Check
```bash
# Check if reasoning engine is running
ps aux | grep reasoning_engine

# Check recent plans generated
ls -lt AI_Employee_Vault/Plans/ | head -10

# Check pending approvals
ls -la AI_Employee_Vault/Needs_Action/ | grep Plan
```

### Performance Metrics
- Plans generated per day
- Average time from task to plan
- Risk distribution (Low/Medium/High)
- Approval rate (approved vs rejected)
- Plan quality score (manual review)

## Error Handling

### Common Issues

**Task Content Unclear**
- Generate plan with "Clarification Needed" status
- Request more information from user
- Log ambiguous task for review

**Risk Assessment Uncertain**
- Default to higher risk level (err on side of caution)
- Flag for human review
- Log uncertainty for future improvement

**Plan Generation Failed**
- Log error with full context
- Move task to manual review queue
- Alert user of failure

## Testing

### Unit Tests
```python
# test_plan_generator.py

def test_low_risk_detection():
    task = "Generate a summary of completed tasks"
    risk, reason = assess_risk_level(task)
    assert risk == "Low"

def test_medium_risk_detection():
    task = "Send email to client with proposal"
    risk, reason = assess_risk_level(task)
    assert risk == "Medium"

def test_high_risk_detection():
    task = "Delete all old files and process payment"
    risk, reason = assess_risk_level(task)
    assert risk == "High"

def test_plan_structure():
    task_file = "test_task.md"
    plan = generate_plan(task_file)
    assert "Goal:" in plan
    assert "Steps:" in plan
    assert "Risk Level:" in plan
    assert "Approval Status:" in plan
```

### Integration Tests
```bash
# Create test task
echo "Test task: Generate weekly report" > AI_Employee_Vault/Inbox/test.md

# Wait for plan generation
sleep 5

# Verify plan created
ls AI_Employee_Vault/Plans/ | grep test

# Verify plan structure
grep "Goal:" AI_Employee_Vault/Plans/*test*.md
```

## Continuous Improvement

### Learning from Feedback

Track plan outcomes to improve future planning:

```python
# plan_feedback.json
{
    "plan_id": "20260216-103045-Plan",
    "task_type": "email_response",
    "risk_assigned": "Medium",
    "risk_actual": "Low",
    "execution_success": true,
    "human_feedback": "Risk was overestimated, could be auto-approved",
    "improvement": "Adjust risk for known contacts"
}
```

### Metrics to Track
- Risk assessment accuracy
- Plan execution success rate
- Time from plan to completion
- Human override frequency
- Common failure patterns

## Dependencies

```python
# Part of reasoning_engine.py
import os
import json
from datetime import datetime
from pathlib import Path
```

## Logs

**Location**: `logs/silver.log`

**Format**:
```
[2026-02-16 10:30:45] [PLAN_GENERATOR] ACTION - New task detected: test_task.md
[2026-02-16 10:30:46] [PLAN_GENERATOR] ACTION - Analyzing task content
[2026-02-16 10:30:47] [PLAN_GENERATOR] ACTION - Risk assessed: Low
[2026-02-16 10:30:48] [PLAN_GENERATOR] ACTION - Plan generated: 20260216-103048-Plan.md
[2026-02-16 10:30:49] [PLAN_GENERATOR] ACTION - Routed to /Plans (auto-approve)
```

## Future Enhancements

- [ ] Machine learning for risk assessment
- [ ] Natural language understanding for complex tasks
- [ ] Multi-step plan optimization
- [ ] Dependency graph generation
- [ ] Estimated time to completion
- [ ] Resource requirement prediction
- [ ] Integration with project management tools

## References

- Reasoning Engine: `../../AI_Employee_Vault/reasoning_engine.py`
- Bronze Task Processor: `../../AI_Employee_Vault/task_processor.py`
- Silver Architecture: `../docs/silver_architecture.md`
